<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Authentication</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8b;
        }
        .result {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { background: #ffe6e6; border-left: 4px solid #ff0000; }
        .success { background: #e6ffe6; border-left: 4px solid #00aa00; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>üîç Authentication Debug Tool</h1>
    
    <div class="debug-section">
        <h2>1. Check Back4App Configuration</h2>
        <button onclick="checkConfig()">Check Config</button>
        <div id="config-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>2. Test API Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connection-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>3. Fetch Users from Database</h2>
        <button onclick="fetchUsers()">Get All Users</button>
        <div id="users-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>4. Create Test Users</h2>
        <p>Since your User table is empty, let's create some test users:</p>
        <button onclick="createTestUsers()">Create Test Users</button>
        <div id="create-users-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>4. Test Authentication with Real Users</h2>
        <p>Try these actual usernames from your database:</p>
        <div style="margin: 10px 0;">
            <button onclick="setTestUser('Admin', '123456')">Admin / 123456</button>
            <button onclick="setTestUser('kim01', 'admin123')">kim01 / admin123</button>
            <button onclick="setTestUser('hadiroh', 'password')">hadiroh / password</button>
            <button onclick="setTestUser('sroe01', 'sroe01')">sroe01 / sroe01</button>
            <button onclick="setTestUser('Kim', 'Kim123')">Kim / Kim123</button>
        </div>
        <input type="text" id="test-username" placeholder="Username" value="Admin">
        <input type="password" id="test-password" placeholder="Password" value="123456">
        <button onclick="testAuth()">Test Authentication</button>
        <div id="auth-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h2>6. Console Logs</h2>
        <p>Open browser console (F12) to see detailed logs during testing.</p>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api-service.js"></script>
    <script>
        function displayResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(content, null, 2);
            element.className = `result ${isError ? 'error' : 'success'}`;
        }

        function checkConfig() {
            console.log('üîß Checking configuration...');
            const configResult = {
                configExists: typeof CONFIG !== 'undefined',
                baseUrl: CONFIG?.API_BASE_URL || 'Not found',
                fullApiUrl: CONFIG?.API_BASE_URL ? `${CONFIG.API_BASE_URL}/parse` : 'Not found',
                appId: CONFIG?.APP_ID || 'Not found',
                restKey: CONFIG?.REST_API_KEY || 'Not found',
                apiServiceUrl: typeof apiService !== 'undefined' ? apiService.apiUrl : 'API Service not found',
                timestamp: new Date().toISOString()
            };
            
            console.log('üìã Config check result:', configResult);
            displayResult('config-result', configResult);
        }

        async function testConnection() {
            console.log('üåê Testing API connection...');
            try {
                // Test with a valid Back4App endpoint using the apiService
                const testUrl = `${apiService.apiUrl}/classes/_User`;
                console.log('üîó Testing URL:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'X-Parse-Application-Id': CONFIG.APP_ID,
                        'X-Parse-REST-API-Key': CONFIG.REST_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                let responseData = null;
                try {
                    responseData = await response.json();
                } catch (e) {
                    const textData = await response.text();
                    responseData = { parseError: 'Could not parse response as JSON', responseText: textData };
                }
                
                const result = {
                    testUrl: testUrl,
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    responseData: responseData,
                    timestamp: new Date().toISOString()
                };
                
                console.log('üì° Connection test result:', result);
                displayResult('connection-result', result, !response.ok);
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                displayResult('connection-result', { error: error.message }, true);
            }
        }

        async function fetchUsers() {
            console.log('üë• Fetching users with multiple methods...');
            
            // Method 1: Try the current API service method
            try {
                console.log('üì° Method 1: Using API Service...');
                const users1 = await apiService.getUsers();
                displayResult('users-result', {
                    method: 'API Service getUsers()',
                    userCount: users1.length,
                    users: users1,
                    timestamp: new Date().toISOString()
                });
            } catch (error) {
                console.error('‚ùå Method 1 failed:', error);
            }

            // Method 2: Try direct REST API call to _User
            try {
                console.log('üì° Method 2: Direct _User class call...');
                const response2 = await fetch(`${apiService.apiUrl}/classes/_User?limit=1000`, {
                    method: 'GET',
                    headers: {
                        'X-Parse-Application-Id': CONFIG.APP_ID,
                        'X-Parse-REST-API-Key': CONFIG.REST_API_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data2 = await response2.json();
                console.log('üìä Method 2 response:', data2);
                
                document.getElementById('users-result').innerHTML += `
                    <hr><strong>Method 2 - Direct _User class:</strong><br>
                    Status: ${response2.status}<br>
                    Users found: ${data2.results ? data2.results.length : 0}<br>
                    Data: ${JSON.stringify(data2, null, 2)}
                `;
            } catch (error) {
                console.error('‚ùå Method 2 failed:', error);
            }

            // Method 3: Try with different query parameters
            try {
                console.log('üì° Method 3: With master key simulation...');
                const response3 = await fetch(`${apiService.apiUrl}/classes/_User?limit=1000&include=*`, {
                    method: 'GET',
                    headers: {
                        'X-Parse-Application-Id': CONFIG.APP_ID,
                        'X-Parse-REST-API-Key': CONFIG.REST_API_KEY,
                        'X-Parse-Master-Key': CONFIG.REST_API_KEY, // Try using REST key as master key
                        'Content-Type': 'application/json'
                    }
                });
                
                const data3 = await response3.json();
                console.log('üìä Method 3 response:', data3);
                
                document.getElementById('users-result').innerHTML += `
                    <hr><strong>Method 3 - With master key:</strong><br>
                    Status: ${response3.status}<br>
                    Users found: ${data3.results ? data3.results.length : 0}<br>
                    Data: ${JSON.stringify(data3, null, 2)}
                `;
            } catch (error) {
                console.error('‚ùå Method 3 failed:', error);
            }
        }

        async function testAuth() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            
            console.log('üîê Testing authentication for:', username);
            try {
                const result = await apiService.authenticateUser(username, password);
                console.log('üîç Authentication result:', result);
                displayResult('auth-result', result, !result.success);
            } catch (error) {
                console.error('‚ùå Authentication test failed:', error);
                displayResult('auth-result', { error: error.message }, true);
            }
        }

        function setTestUser(username, password) {
            document.getElementById('test-username').value = username;
            document.getElementById('test-password').value = password;
            console.log('üë§ Set test user:', username, '/', password);
        }

        async function createTestUsers() {
            console.log('üë• Creating test users...');
            try {
                const testUsers = [
                    { username: 'admin', password: 'admin123', email: 'admin@school.com' },
                    { username: 'teacher1', password: 'teacher123', email: 'teacher1@school.com' },
                    { username: 'principal', password: 'principal123', email: 'principal@school.com' }
                ];

                const results = [];
                for (const userData of testUsers) {
                    console.log('Creating user:', userData.username);
                    
                    const response = await fetch(`${apiService.apiUrl}/classes/_User`, {
                        method: 'POST',
                        headers: {
                            'X-Parse-Application-Id': CONFIG.APP_ID,
                            'X-Parse-REST-API-Key': CONFIG.REST_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: userData.username,
                            password: userData.password,
                            email: userData.email,
                            plainPassword: userData.password // Store plain password for easy testing
                        })
                    });

                    const result = await response.json();
                    results.push({
                        username: userData.username,
                        status: response.status,
                        success: response.ok,
                        result: result
                    });
                }

                console.log('‚úÖ User creation results:', results);
                displayResult('create-users-result', {
                    message: 'Test users created successfully!',
                    users: results,
                    timestamp: new Date().toISOString()
                });

                // Refresh users list after creation
                setTimeout(() => {
                    console.log('üîÑ Refreshing user list...');
                    fetchUsers();
                }, 1000);

            } catch (error) {
                console.error('‚ùå Failed to create test users:', error);
                displayResult('create-users-result', { error: error.message }, true);
            }
        }

        // Auto-run config check on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Debug page loaded');
            checkConfig();
        });
    </script>
</body>
</html>