<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Management - School Management System</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-graduation-cap"></i> School Portal</h3>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="students.html" class="nav-item">
                <i class="fas fa-user-graduate"></i>
                <span>Students</span>
            </a>
            <a href="teachers.html" class="nav-item">
                <i class="fas fa-chalkboard-teacher"></i>
                <span>Teachers</span>
            </a>
            <a href="classes.html" class="nav-item active">
                <i class="fas fa-book-open"></i>
                <span>Classes</span>
            </a>
            <a href="results.html" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span>Results</span>
            </a>
            <a href="settings.html" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <div class="main-content">
        <header class="main-header">
            <h1>Class Management</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showAddClassModal()">
                    <i class="fas fa-plus"></i> Add Class
                </button>
            </div>
        </header>

        <div class="content-wrapper">
            <!-- Search and Filters -->
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="class-search" placeholder="Search classes..." class="search-input">
                </div>
                <select id="teacher-filter" class="filter-select">
                    <option value="">All Teachers</option>
                    <!-- Dynamic options will be loaded here -->
                </select>
            </div>

            <!-- Classes Grid -->
            <div class="classes-grid" id="classes-grid">
                <!-- Dynamic content will be loaded here -->
            </div>

            <!-- Loading indicator -->
            <div id="loading-indicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Loading classes...</p>
            </div>

            <!-- Empty state -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-book-open"></i>
                <h3>No Classes Found</h3>
                <p>Start by adding your first class to the system.</p>
                <button class="btn btn-primary" onclick="showAddClassModal()">
                    <i class="fas fa-plus"></i> Add Class
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Class Modal -->
    <div id="class-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add Class</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="class-form" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="class-name">Class Name *</label>
                        <input type="text" id="class-name" name="name" required placeholder="e.g., Class A, Grade 1">
                    </div>
                    <div class="form-group">
                        <label for="class-code">Class Code</label>
                        <input type="text" id="class-code" name="code" placeholder="e.g., CLS-A-001">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="class-teacher">Class Teacher</label>
                        <select id="class-teacher" name="teacherId">
                            <option value="">Select Teacher</option>
                            <!-- Dynamic options will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="class-capacity">Maximum Capacity</label>
                        <input type="number" id="class-capacity" name="capacity" min="1" max="100" placeholder="e.g., 30">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="class-room">Room Number</label>
                        <input type="text" id="class-room" name="roomNumber" placeholder="e.g., Room 101">
                    </div>
                    <div class="form-group">
                        <label for="class-schedule">Schedule</label>
                        <input type="text" id="class-schedule" name="schedule" placeholder="e.g., Mon-Fri 9:00-15:00">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="class-description">Description</label>
                        <textarea id="class-description" name="description" rows="3" placeholder="Brief description of the class..."></textarea>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submit-text">Add Class</span>
                        <div id="submit-spinner" class="button-spinner" style="display: none;"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Class Details Modal -->
    <div id="class-details-modal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 id="details-modal-title">Class Details</h2>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="class-details-tabs">
                    <button class="tab-button active" onclick="showTab(event, 'overview-tab')">Overview</button>
                    <button class="tab-button" onclick="showTab(event, 'students-tab')">Students</button>
                    <button class="tab-button" onclick="showTab(event, 'schedule-tab')">Schedule</button>
                </div>
                
                <div id="overview-tab" class="tab-content active">
                    <div class="class-overview" id="class-overview">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
                
                <div id="students-tab" class="tab-content">
                    <div class="class-students" id="class-students">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
                
                <div id="schedule-tab" class="tab-content">
                    <div class="class-schedule" id="class-schedule-content">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/api-service.js"></script>
    <script src="js/navigation.js"></script>
    
    <script>
        // Class Management System
        class ClassManager {
            constructor(apiService) {
                this.apiService = apiService;
                this.classes = [];
                this.teachers = [];
                this.students = [];
                this.init();
            }

            async init() {
                await this.loadTeachers();
                await this.loadStudents();
                await this.loadClasses();
                this.setupEventListeners();
            }

            async loadClasses() {
                try {
                    this.showLoading(true);
                    this.classes = await this.apiService.getClasses();
                    this.renderClasses();
                    this.showEmptyState(this.classes.length === 0);
                } catch (error) {
                    console.error('Error loading classes:', error);
                    this.showNotification('Error loading classes', 'error');
                    this.showEmptyState(true);
                } finally {
                    this.showLoading(false);
                }
            }

            async loadTeachers() {
                try {
                    this.teachers = await this.apiService.getTeachers();
                    this.populateTeacherOptions();
                } catch (error) {
                    console.error('Error loading teachers:', error);
                }
            }

            async loadStudents() {
                try {
                    this.students = await this.apiService.getStudents();
                } catch (error) {
                    console.error('Error loading students:', error);
                }
            }

            renderClasses() {
                const grid = document.getElementById('classes-grid');
                if (!grid) return;

                grid.innerHTML = this.classes.map(cls => `
                    <div class="class-card" data-class-id="${cls.objectId}">
                        <div class="class-card-header">
                            <h3>${cls.name}</h3>
                            <div class="class-actions">
                                <button class="btn-icon" onclick="classManager.editClass('${cls.objectId}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="classManager.deleteClass('${cls.objectId}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="class-card-body">
                            <div class="class-info">
                                <div class="info-item">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                    <span>${this.getTeacherName(cls.teacherId) || 'No teacher assigned'}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-users"></i>
                                    <span>${this.getStudentCount(cls.objectId)} students</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-door-open"></i>
                                    <span>${cls.roomNumber || 'No room assigned'}</span>
                                </div>
                                ${cls.schedule ? `
                                    <div class="info-item">
                                        <i class="fas fa-clock"></i>
                                        <span>${cls.schedule}</span>
                                    </div>
                                ` : ''}
                            </div>
                            ${cls.description ? `
                                <p class="class-description">${cls.description}</p>
                            ` : ''}
                        </div>
                        <div class="class-card-footer">
                            <button class="btn btn-outline" onclick="classManager.viewClassDetails('${cls.objectId}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            getTeacherName(teacherId) {
                const teacher = this.teachers.find(t => t.objectId === teacherId);
                return teacher ? teacher.name : null;
            }

            getStudentCount(classId) {
                return this.students.filter(s => s.classId === classId).length;
            }

            populateTeacherOptions() {
                const select = document.getElementById('class-teacher');
                if (!select) return;

                // Clear existing options except the first one
                select.innerHTML = '<option value="">Select Teacher</option>';
                
                this.teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.objectId;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });

                // Populate filter dropdown
                const filter = document.getElementById('teacher-filter');
                if (filter) {
                    filter.innerHTML = '<option value="">All Teachers</option>';
                    this.teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.objectId;
                        option.textContent = teacher.name;
                        filter.appendChild(option);
                    });
                }
            }

            setupEventListeners() {
                // Form submission
                const form = document.getElementById('class-form');
                if (form) {
                    form.addEventListener('submit', (e) => this.handleFormSubmit(e));
                }

                // Search functionality
                const searchInput = document.getElementById('class-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                }

                // Filter functionality
                const teacherFilter = document.getElementById('teacher-filter');
                if (teacherFilter) {
                    teacherFilter.addEventListener('change', (e) => this.handleFilter(e.target.value));
                }
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const classData = Object.fromEntries(formData.entries());
                
                try {
                    this.showSubmitSpinner(true);
                    
                    if (this.editingClassId) {
                        await this.apiService.updateClass(this.editingClassId, classData);
                        this.showNotification('Class updated successfully!', 'success');
                    } else {
                        await this.apiService.createClass(classData);
                        this.showNotification('Class added successfully!', 'success');
                    }
                    
                    this.closeModal();
                    await this.loadClasses();
                } catch (error) {
                    console.error('Error saving class:', error);
                    this.showNotification('Error saving class. Please try again.', 'error');
                } finally {
                    this.showSubmitSpinner(false);
                }
            }

            handleSearch(query) {
                const filteredClasses = this.classes.filter(cls => 
                    cls.name.toLowerCase().includes(query.toLowerCase()) ||
                    cls.code?.toLowerCase().includes(query.toLowerCase()) ||
                    this.getTeacherName(cls.teacherId)?.toLowerCase().includes(query.toLowerCase())
                );
                this.renderFilteredClasses(filteredClasses);
            }

            handleFilter(teacherId) {
                const filteredClasses = teacherId ? 
                    this.classes.filter(cls => cls.teacherId === teacherId) : 
                    this.classes;
                this.renderFilteredClasses(filteredClasses);
            }

            renderFilteredClasses(classes) {
                // Temporarily store filtered classes and render
                const originalClasses = this.classes;
                this.classes = classes;
                this.renderClasses();
                this.classes = originalClasses;
                this.showEmptyState(classes.length === 0);
            }

            async editClass(classId) {
                const cls = this.classes.find(c => c.objectId === classId);
                if (!cls) return;

                this.editingClassId = classId;
                this.showAddClassModal();
                
                // Populate form with class data
                document.getElementById('modal-title').textContent = 'Edit Class';
                document.getElementById('submit-text').textContent = 'Update Class';
                document.getElementById('class-name').value = cls.name || '';
                document.getElementById('class-code').value = cls.code || '';
                document.getElementById('class-teacher').value = cls.teacherId || '';
                document.getElementById('class-capacity').value = cls.capacity || '';
                document.getElementById('class-room').value = cls.roomNumber || '';
                document.getElementById('class-schedule').value = cls.schedule || '';
                document.getElementById('class-description').value = cls.description || '';
            }

            async deleteClass(classId) {
                if (!confirm('Are you sure you want to delete this class?')) return;
                
                try {
                    await this.apiService.deleteClass(classId);
                    this.showNotification('Class deleted successfully!', 'success');
                    await this.loadClasses();
                } catch (error) {
                    console.error('Error deleting class:', error);
                    this.showNotification('Error deleting class. Please try again.', 'error');
                }
            }

            viewClassDetails(classId) {
                const cls = this.classes.find(c => c.objectId === classId);
                if (!cls) return;

                document.getElementById('details-modal-title').textContent = cls.name;
                this.showClassOverview(cls);
                this.showClassStudents(cls);
                this.showClassSchedule(cls);
                document.getElementById('class-details-modal').style.display = 'block';
            }

            showClassOverview(cls) {
                const overview = document.getElementById('class-overview');
                if (!overview) return;

                const teacherName = this.getTeacherName(cls.teacherId);
                const studentCount = this.getStudentCount(cls.objectId);

                overview.innerHTML = `
                    <div class="overview-grid">
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="card-content">
                                <h4>Class Teacher</h4>
                                <p>${teacherName || 'Not assigned'}</p>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="card-content">
                                <h4>Total Students</h4>
                                <p>${studentCount}</p>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div class="card-content">
                                <h4>Room Number</h4>
                                <p>${cls.roomNumber || 'Not assigned'}</p>
                            </div>
                        </div>
                        <div class="overview-card">
                            <div class="card-icon">
                                <i class="fas fa-users-cog"></i>
                            </div>
                            <div class="card-content">
                                <h4>Capacity</h4>
                                <p>${cls.capacity || 'Not set'}</p>
                            </div>
                        </div>
                    </div>
                    ${cls.description ? `
                        <div class="description-section">
                            <h4>Description</h4>
                            <p>${cls.description}</p>
                        </div>
                    ` : ''}
                `;
            }

            showClassStudents(cls) {
                const studentsContainer = document.getElementById('class-students');
                if (!studentsContainer) return;

                const classStudents = this.students.filter(s => s.classId === cls.objectId);

                if (classStudents.length === 0) {
                    studentsContainer.innerHTML = `
                        <div class="empty-state-small">
                            <i class="fas fa-user-graduate"></i>
                            <p>No students enrolled in this class</p>
                        </div>
                    `;
                    return;
                }

                studentsContainer.innerHTML = `
                    <div class="students-list">
                        ${classStudents.map(student => `
                            <div class="student-item">
                                <div class="student-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="student-info">
                                    <h4>${student.name}</h4>
                                    <p>ID: ${student.studentId}</p>
                                    <p>${student.email || 'No email'}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            showClassSchedule(cls) {
                const scheduleContainer = document.getElementById('class-schedule-content');
                if (!scheduleContainer) return;

                scheduleContainer.innerHTML = `
                    <div class="schedule-info">
                        <div class="schedule-item">
                            <i class="fas fa-clock"></i>
                            <strong>Schedule:</strong> ${cls.schedule || 'Not set'}
                        </div>
                        <div class="schedule-item">
                            <i class="fas fa-calendar"></i>
                            <strong>Academic Year:</strong> 2024-2025
                        </div>
                        <div class="schedule-item">
                            <i class="fas fa-book"></i>
                            <strong>Subjects:</strong> All core subjects
                        </div>
                    </div>
                `;
            }

            showAddClassModal() {
                this.editingClassId = null;
                document.getElementById('modal-title').textContent = 'Add Class';
                document.getElementById('submit-text').textContent = 'Add Class';
                document.getElementById('class-form').reset();
                document.getElementById('class-modal').style.display = 'block';
            }

            closeModal() {
                document.getElementById('class-modal').style.display = 'none';
                this.editingClassId = null;
            }

            closeDetailsModal() {
                document.getElementById('class-details-modal').style.display = 'none';
            }

            showLoading(show) {
                const loading = document.getElementById('loading-indicator');
                if (loading) {
                    loading.style.display = show ? 'flex' : 'none';
                }
            }

            showEmptyState(show) {
                const emptyState = document.getElementById('empty-state');
                const grid = document.getElementById('classes-grid');
                if (emptyState && grid) {
                    emptyState.style.display = show ? 'flex' : 'none';
                    grid.style.display = show ? 'none' : 'grid';
                }
            }

            showSubmitSpinner(show) {
                const spinner = document.getElementById('submit-spinner');
                const text = document.getElementById('submit-text');
                if (spinner && text) {
                    spinner.style.display = show ? 'block' : 'none';
                    text.style.display = show ? 'none' : 'block';
                }
            }

            showNotification(message, type) {
                const container = document.getElementById('notification-container');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // Tab functionality
        function showTab(evt, tabName) {
            const tabContent = document.getElementsByClassName('tab-content');
            const tabButtons = document.getElementsByClassName('tab-button');
            
            for (let i = 0; i < tabContent.length; i++) {
                tabContent[i].classList.remove('active');
            }
            
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // Global functions for modal management
        function showAddClassModal() {
            if (window.classManager) {
                window.classManager.showAddClassModal();
            }
        }

        function closeModal() {
            if (window.classManager) {
                window.classManager.closeModal();
            }
        }

        function closeDetailsModal() {
            if (window.classManager) {
                window.classManager.closeDetailsModal();
            }
        }

        // Initialize class management when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const navigation = new NavigationManager();
            
            if (typeof apiService !== 'undefined') {
                window.classManager = new ClassManager(apiService);
            } else {
                console.error('API service not available');
            }

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                const classModal = document.getElementById('class-modal');
                const detailsModal = document.getElementById('class-details-modal');
                
                if (event.target === classModal) {
                    closeModal();
                }
                if (event.target === detailsModal) {
                    closeDetailsModal();
                }
            });
        });
    </script>
</body>
</html>